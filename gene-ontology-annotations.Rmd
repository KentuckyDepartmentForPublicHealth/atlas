
# Main annotation assignment

```{r}

library(org.Hs.eg.db)

# Column Availability
# cols_available <- columns(org.Hs.eg.db)

# Map Entrez IDs to Gene Symbols and Names
gene_annotations <- AnnotationDbi::select(org.Hs.eg.db,
                                          keys = rownames(geneExpressionData),
                                          columns = c("SYMBOL", "GENENAME"),
                                          # columns = cols_available,
                                          keytype = "ENTREZID")

# Potential shift in data stucture
# geneExpressionDataAnnotated <- merge(geneExpressionData, gene_annotations, by.x = "row.names", by.y = "ENTREZID", all.x = TRUE)

```


# Find missing annotations

```{r}

library(rentrez)

fetch_gene_info <- function(id) {
  result <- entrez_summary(db="gene", id=id)
  return(data.frame(ENTREZID = id, 
                    SYMBOL = result$name, 
                    GENENAME = result$description))
}

# Fetch info for missing IDs
missing_ids <- gene_annotations$ENTREZID[is.na(gene_annotations$SYMBOL)]
new_annotations <- do.call(rbind, lapply(missing_ids, fetch_gene_info))

```

## Add annotations where SYMBOL is NA


```{r}

# glimpse(gene_annotations)
# table(is.na(gene_annotations$SYMBOL))
# glimpse(new_annotations)
library(dplyr)

# Update gene_annotations where SYMBOL is NA using new_annotations
gene_annotations <- gene_annotations %>%
  left_join(new_annotations, by = "ENTREZID", suffix = c(".orig", ".new")) %>%
  mutate(
    SYMBOL = if_else(is.na(SYMBOL.orig), SYMBOL.new, SYMBOL.orig),
    GENENAME = if_else(is.na(SYMBOL.orig), GENENAME.new, GENENAME.orig)
  ) %>%
  select(ENTREZID, SYMBOL, GENENAME)

# Check the number of NAs in SYMBOL after updating
# table(is.na(gene_annotations$SYMBOL))
#freq(is.na(gene_annotations$SYMBOL))
# li(gene_annotations$ENTREZID, rownames(geneExpressionData))


```



# Gene Ontology
## Biological process 1

```{r}

library(clusterProfiler)

# gene ontology terms
go_annotations <- enrichGO(gene = rownames(geneExpressionData),
                            OrgDb = org.Hs.eg.db,
                            ont = "BP", # Biological Process (or: “BP”, “MF”, “CC”, “ALL”)
                            keyType = "ENTREZID")
# head(go_annotations)

# Extract gene-to-GO mapping
# This creates a named list where:
# 
# The names are GO terms (descriptions).
# The values are comma-separated gene IDs.
go_to_genes <- setNames(go_annotations@result$geneID, go_annotations@result$Description)

# Split the gene IDs into vectors
go_to_genes_list <- lapply(go_to_genes, function(x) unlist(strsplit(x, "/")))

# Find overlap with your gene expression data
# mapped_genes <- lapply(go_to_genes_list, function(genes) {
#   intersect(genes, rownames(geneExpressionData))
# })

```



```{r}

# all_possible_genes <- select(gene_annotations, SYMBOL) %>% 
#   filter(!is.na(SYMBOL)) %>% 
#   pull(SYMBOL)


```

# Save

```{r}

save(gene_annotations, go_to_genes_list, file = 'dat/annotations.RData')

```


```{r}


```


```{r}


```


```{r}


```


```{r}


```


```{r}


```

